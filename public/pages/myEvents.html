<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Events</title>
    <link rel="stylesheet" href="../styles/create_modify_event.css" />
    <link rel="stylesheet" href="../styles/navbar.css" />
    <link rel="stylesheet" href="../styles/leagues.css" />
    <link rel="stylesheet" href="../styles/event.css" />
    <link rel="stylesheet" href="../styles/eventcard.css" />
    <link rel="stylesheet" href="../styles/leaguecard.css" />
    <link rel="stylesheet" href="../styles/selectedsport.css" />
    <link rel="stylesheet" href="../styles/yesnobutton.css" />
  </head>

  <body>
    <!-- Confirmation Modal -->
    <div id="confirmation-modal-cancel" class="modal">
      <p class="question">Are you sure you would like to cancel?</p>
      <button id="cancel-no" class="no-button">NO, GO BACK</button>
      <button id="cancel-yes" class="yes-button" ;>YES, CANCEL</button>
    </div>

    <!-- Deletion Modal -->
    <div id="confirmation-modal-delete" class="modal">
      <p class="question">Are you sure you would like to delete this event?</p>
      <button id="delete-no" class="no-button">NO, GO BACK</button>
      <button id="delete-yes" class="yes-button" ;>YES, DELETE</button>
    </div>

    <div id="main-content">
      <nav class="navbar">
        <div class="nav-logo">
          <img src="../assets/icons/icon_logo.svg" />
          <span>BeyondSports</span>
        </div>
        <div class="nav-search">
          <input type="text" placeholder="Search for anything" />
        </div>
        <ul class="nav-links">
          <li><a href="/pages/homepage.html">Home</a></li>
          <li><a href="/pages/myEvents.html">My Events</a></li>
          <li><a href="/pages/myLeagues.html">My Leagues</a></li>
        </ul>
        <div class="nav-create">
          <button class="dropbtn">Create</button>
          <div class="dropdown-content">
            <a href="/pages/create_modify_event.html">Event</a>
            <a href="/pages/create_modify_league.html">League</a>
          </div>
        </div>
        <div class="nav-toggle">
          <div class="nav-toggle-icon"></div>
          <div class="nav-dropdown">
            <a href="/pages/homepage.html">Home</a>
            <a href="/pages/myEvents.html">My Events</a>
            <a href="/pages/myLeagues.html">My Leagues</a>
            <a href="/pages/create_modify_event.html">Create an Event</a>
            <a href="/pages/create_modify_league.html">Create a League</a>
            <input type="text" placeholder="Search" />
          </div>
        </div>
      </nav>

      <h1>Your Confirmed Events:</h1>

      <div class="events-container participated-container">
        <!-- First event card -->
        <div class="event-card">
          <div class="event-card-picture">
            <img src="../assets/images/basket1.png" />
          </div>
          <div class="event-card-content">
            <div class="event-card-title">Basket Pick Up - Mix</div>
            <div class="event-card-organizer">
              <img src="../assets/icons/icon_person.svg" class="icon" />Zeid
              Solh
            </div>
            <div class="event-card-location">
              <img src="../assets/icons/icon_map.svg" class="icon" />RSF
            </div>
            <div class="event-card-description">
              Come take a break from your midterms and play some Basket with our
              team leader Zeid.
            </div>
            <hr class="card-divider" />
            <div class="event-card-time">
              <p>Time</p>
              <div class="time-shape">7:30PM</div>
            </div>
            <div class="event-card-actions">
              <button class="event-card-button confirmed">CONFIRMED</button>
              <button class="event-card-button cancel">CANCEL</button>
            </div>
          </div>
        </div>
      </div>

      <h1>Your Created Events:</h1>

      <div class="events-container created-container">
        <!-- Second event card -->
        <div class="event-card">
          <div class="event-card-picture">
            <img src="../assets/images/basket2.png" />
          </div>
          <div class="event-card-content">
            <div class="event-card-title">Basket Pick Up - Mix</div>
            <div class="event-card-organizer">
              <img src="../assets/icons/icon_person.svg" class="icon" />Zeid
              Solh
            </div>
            <div class="event-card-location">
              <img src="../assets/icons/icon_map.svg" class="icon" />RSF
            </div>
            <div class="event-card-description">
              Come take a break from your midterms and play some Basket with our
              team leader Zeid.
            </div>
            <hr class="card-divider" />
            <div class="event-card-time">
              <p>Time</p>
              <div class="time-shape">6:30PM</div>
            </div>
            <div class="event-card-actions">
              <button class="event-card-button confirmed">MODIFY</button>
              <button class="event-card-button cancel">DELETE</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Second event card -->
      <!-- <div class="event-card">
        <div class="event-card-picture">
          <img src="../assets/images/basket2.png" />
        </div>
        <div class="event-card-content">
          <div class="event-card-title">Basket Pick Up - Mix</div>
          <div class="event-card-organizer">
            <img src="../assets/icons/icon_person.svg" class="icon" />Zeid Solh
          </div>
          <div class="event-card-location">
            <img src="../assets/icons/icon_map.svg" class="icon" />RSF
          </div>
          <div class="event-card-description">
            Come take a break from your midterms and play some Basket with our
            team leader Zeid.
          </div>
          <hr class="card-divider" />
          <div class="event-card-time">
            <p>Time</p>
            <div class="time-shape">6:30PM</div>
          </div>
          <div class="event-card-actions">
            <button class="event-card-button confirmed">MODIFY</button>
            <button class="event-card-button cancel">CANCEL</button>
          </div>
        </div>
      </div>
    </div> -->
    </div>

    <!-- Main Content -->
    <!-- <div id="main-content" class="blur">
        Your main page content here 
    </div> -->
  </body>
  <script src="../scripts/rsvp.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const userId = getUserId(); // You will need to implement this function to fetch the user's ID, e.g., from session or local storage.

      fetch(`/events/user/${userId}`)
        .then((response) => response.json())
        .then((events) => {
          updateEvents(events);
          attachCancelEventListeners();
        })
        .catch((error) => console.error("Error fetching user events:", error));

      // Fetch events created by the user
      fetch(`/events/created/${userId}`)
        .then((response) => response.json())
        .then((createdEvents) => {
          updateCreatedEvents(createdEvents);
          attachDeleteEventListeners();
          attachModifyEventListeners();
        })
        .catch((error) =>
          console.error("Error fetching created events:", error)
        );
    });

    function updateEvents(events) {
      const container = document.querySelector(".participated-container");
      container.innerHTML = ""; // Clear any existing content
      events.forEach((event) => {
        const accessibility = event.accessibility
          .split(",")
          .map(
            (word) => word.trim().charAt(0).toUpperCase() + word.trim().slice(1)
          )
          .join(", ");
        const description =
          event.description.length > 80
            ? event.description.substring(0, 80) + "..."
            : event.description;
        const eventHtml = `
                <div class="event-card" onclick="redirectToEventPage(${
                  event.id
                })">
                    <div class="event-card-picture">
                        <img src="${
                          event.imageUrl || "../assets/images/default.png"
                        }" />
                    </div>
                    <div class="event-card-content">
                        <div class="event-card-title">${event.eventName}</div>
                        <div class="event-card-organizer">
                            <img src="../assets/icons/icon_person.svg" class="icon" />${accessibility}
                        </div>
                        <div class="event-card-location">
                            <img src="../assets/icons/icon_map.svg" class="icon" />${
                              event.city
                            }, ${event.state}
                        </div>
                        <div class="event-card-description">${description}</div>
                        <hr class="card-divider" />
                        <div class="event-card-time">
                            <p>Time</p>
                            <div class="time-shape">${
                              event.eventTime
                            }, ${formatDate(event.eventDate)}</div>
                        </div>
                        <div class="event-card-actions">
                            <button class="event-card-button confirmed">CONFIRMED</button>
                            <button class="event-card-button cancel" data-event-id="${
                              event.id
                            }">CANCEL</button>
                        </div>
                    </div>
                </div>
            `;
        container.insertAdjacentHTML("beforeend", eventHtml);
      });
    }

    function redirectToEventPage(eventId) {
      window.location.href = `/pages/event_confirmed.html?id=${eventId}`;
    }

    function updateCreatedEvents(events) {
      const container = document.querySelector(".created-container");
      container.innerHTML = ""; // Clear any existing content
      events.forEach((event) => {
        const accessibility = event.accessibility
          .split(",")
          .map(
            (word) => word.trim().charAt(0).toUpperCase() + word.trim().slice(1)
          )
          .join(", ");
        const description =
          event.description.length > 80
            ? event.description.substring(0, 80) + "..."
            : event.description;
        const eventHtml = `<div class="event-card" onclick="redirectToEventCreatedPage(${
          event.id
        })">
        <div class="event-card-picture">
          <img src="${event.imageUrl || "../assets/images/default.png"}" />
        </div>
        <div class="event-card-content">
          <div class="event-card-title">${event.eventName}</div>
          <div class="event-card-organizer">
            <img src="../assets/icons/icon_person.svg" class="icon" />${accessibility}
          </div>
          <div class="event-card-location">
            <img src="../assets/icons/icon_map.svg" class="icon" />${
              event.city
            }, ${event.state}
          </div>
          <div class="event-card-description">${description}</div>
          <hr class="card-divider" />
          <div class="event-card-time">
            <p>Time</p>
            <div class="time-shape">${event.eventTime}, ${formatDate(
          event.eventDate
        )}</div>
          </div>
          <div class="event-card-actions">
            <button class="event-card-button modify" data-event-id="${
              event.id
            }">MODIFY</button>
            <button class="event-card-button delete" data-event-id="${
              event.id
            }">DELETE</button>
          </div>
        </div>
      </div>`;
        container.insertAdjacentHTML("beforeend", eventHtml);
      });
    }

    function redirectToEventCreatedPage(eventId) {
      window.location.href = `/pages/event_created.html?id=${eventId}`;
    }

    function attachCancelEventListeners() {
      const cancelButtons = document.querySelectorAll(".cancel");
      cancelButtons.forEach((button) => {
        button.addEventListener("click", function (event) {
          event.stopPropagation(); // Prevent the click event from bubbling up to the parent element
          console.log("Cancel button clicked");
          const eventId = this.getAttribute("data-event-id");
          showConfirmationModal(eventId);
        });
      });
    }

    function showConfirmationModal(eventId) {
      const modal = document.getElementById("confirmation-modal-cancel");
      const mainContent = document.getElementById("main-content");
      modal.style.display = "block";
      mainContent.classList.add("blur");
      // overlay.style.display = 'block';

      // Handle 'No' Button
      document.getElementById("cancel-no").onclick = function () {
        modal.style.display = "none";
        mainContent.classList.remove("blur");
        // overlay.style.display = 'none';
      };

      // Handle 'Yes' Button
      document.getElementById("cancel-yes").onclick = function () {
        cancelRSVP(eventId);
        modal.style.display = "none";
        mainContent.classList.remove("blur");
        // overlay.style.display = 'none';
      };
    }

    function attachDeleteEventListeners() {
      const deleteButtons = document.querySelectorAll(".delete");
      deleteButtons.forEach((button) => {
        button.addEventListener("click", function (event) {
          event.stopPropagation(); // Prevent the click event from bubbling up to the parent element
          console.log("Delete button clicked");
          const eventId = this.getAttribute("data-event-id");
          showDeleteConfirmationModal(eventId);
        });
      });
    }

    function showDeleteConfirmationModal(eventId) {
      const modal = document.getElementById("confirmation-modal-delete");
      const mainContent = document.getElementById("main-content");

      modal.style.display = "block";
      mainContent.classList.add("blur");

      // Handle 'No' Button: hide modal and remove blur
      document.getElementById("delete-no").onclick = function () {
        modal.style.display = "none";
        // overlay.style.display = 'none';
        mainContent.classList.remove("blur");
      };

      // Handle 'Yes' Button: proceed with deletion and remove blur
      document.getElementById("delete-yes").onclick = function () {
        deleteEvent(eventId);
        modal.style.display = "none";
        // overlay.style.display = 'none';
        mainContent.classList.remove("blur");
      };
    }

    function attachModifyEventListeners() {
      const modifyButtons = document.querySelectorAll(".modify");
      modifyButtons.forEach((button) => {
        button.addEventListener("click", function (event) {
          event.stopPropagation(); // Prevent the click event from bubbling up to the parent element
          console.log("Modify button clicked");
          const eventId = this.getAttribute("data-event-id");
          modifyEvent(eventId);
        });
      });
    }

    function cancelRSVP(eventId) {
      const userId = getUserId();
      fetch("/rsvp", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ user_id: userId, event_id: eventId }),
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
          location.reload();
        })
        .catch((error) => console.error("Failed to cancel RSVP:", error));
    }

    function deleteEvent(eventId) {
      const userId = getUserId(); // Retrieve user ID, ensure this matches your auth strategy
      fetch(`/event/${eventId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ userId }),
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
          location.reload(); // Reload the page to update the list of events
        })
        .catch((error) => {
          console.error("Failed to delete event:", error);
          alert("Failed to delete the event.");
        });
    }

    function modifyEvent(eventId) {
      window.location.href = `/pages/modify_event.html?id=${eventId}`;
    }

    function makeCardsClickable() {
      const cards = document.querySelectorAll(selector);
      cards.forEach((card) => {
        card.addEventListener("click", function () {
          const id = this.getAttribute("title"); // Assumes 'title' is used to store the id
          window.location.href = `${redirectPage}?id=${id}`;
        });
      });
    }

    function formatDate(dateStr) {
      const [year, day, month] = dateStr.split("-"); // Split into year, day, month
      return `${month}/${day}/${year}`; // Reformat to MM/DD/YYYY
    }

    function getUserId() {
      // Implement the logic to retrieve the user ID from session or local storage here
      return 1; // Placeholder
    }

    document.addEventListener("DOMContentLoaded", function () {
      const navLinks = document.querySelectorAll(
        ".nav-links li a, .dropdown-content a, .nav-create .dropbtn"
      );
      const navLinksforenter = document.querySelectorAll(
        ".nav-links li, .dropdown-content a, .nav-create .dropbtn"
      );
      // console.log(navLinksforenter);
      // console.log(navLinks);
      navLinksforenter.forEach((item) => {
        const link = item.querySelector("a");
        // if (link == null) {
        //   console.log(item.href);
        // }
        // else {
        //   console.log(link.href);
        // }

        item.addEventListener("click", () => {
          if (link == null) {
            window.location.href = item.href;
          } else {
            window.location.href = link.href;
          }
        });
        item.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            console.log("reached");
            if (link == null) {
              toggleDropdown();
            } else {
              window.location.href = link.href;
            }
          }
        });
      });
    });

    function toggleDropdown() {
      const dropdownContent = document.querySelector(".dropbtn");
      console.log(dropdownContent);
      dropdownContent.style.display =
        dropdownContent.style.display === "block" ? "none" : "block";
    }
  </script>
  <script src="../../scripts/navbar.js"></script>
</html>
